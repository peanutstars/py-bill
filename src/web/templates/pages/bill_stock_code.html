{% extends 'layout.html' %}

{% block content %}
<section>
  <header class="main">
    <div class="row pull-right">
      <div class="btn-group">
        <a type="button" class="button bottom small yellow" href="https://stock.kakao.com/m/stocks/KOREA-A{{extra_info.code}}">K</a>
        <a type="button" class="button bottom small green" href="https://m.stock.naver.com/item/main.nhn#/stocks/{{extra_info.code}}/total">N</a>
      </div>
    </div>
    <h2><a href="{{ url_for('bill_dashboard')}}">{{ extra_info.codename }}({{ extra_info.code }})</a></h2>
  </header>
  <!-- Stock Brief Title -->
  <div class="row">
    <div class="col-5 col-5-medium">
      <div><h2 id="sbrf_tradePrice" style="text-align: right; margin: 0; font-size: 2em"></h2></div>
      <div style="text-align: right; font-weight: 600;" id="sbrf_change" class="stock text">
        <span id="sbrf_changePrice"></span>&nbsp;&nbsp;
        <span id="sbrf_changeRate"></span>
      </div>
    </div>
    <div class="col-7 col-7-medium">
      <img id="sbrf_miniDayChartUrl" style="height: 6.5em;"/>
    </div>
    <p/>
  </div>
  <!-- Candle Chart -->
  <div class="btn-group">
    <button type="button" class="button bottom small gray button-candle" value="candle-day">D</button>
    <button type="button" class="button bottom small button-candle" value="candle-week">W</button>
    <button type="button" class="button bottom small button-candle" value="candle-month">M</button>
  </div>
  <div class="row">
    <img id="candle-day" src="https://ssl.pstatic.net/imgfinance/chart/item/candle/day/{{extra_info.code}}.png" style="width: 100%; height: 350px;"/>
    <img id="candle-week" src="https://ssl.pstatic.net/imgfinance/chart/item/candle/week/{{extra_info.code}}.png" style="width: 100%; height: 350px; display: none;"/>
    <img id="candle-month" src="https://ssl.pstatic.net/imgfinance/chart/item/candle/month/{{extra_info.code}}.png" style="width: 100%; height: 350px; display: none;"/>
    <p/>
  </div>
  <!-- Stock Brief -->
  <div class="row">
    <div class="col-3 col-6-medium">
      <div><span>전일</span><span class="pull-right stock text" id="sbrf_prevClosingPrice"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>고가</span><span class="pull-right stock text" id="sbrf_highPrice"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>시가</span><span class="pull-right stock text" id="sbrf_openingPrice"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>저가</span><span class="pull-right stock text" id="sbrf_lowPrice"></span></div>
    </div>

    <div class="col-3 col-6-medium">
      <div><span>거래량(주)</span><span class="pull-right stock text" id="sbrf_accTradeVolume"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>거래 대금</span><span class="pull-right stock text" id="sbrf_globalAccTradePrice"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>시가 총액</span><span class="pull-right stock text" id="sbrf_totalMarketValue"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>외국인 비중</span><span class="pull-right stock text" id="sbrf_foreignRatio"></span></div>
    </div>

    <div class="col-3 col-6-medium">
      <div><span>EPS</span><span class="pull-right stock text" id="sbrf_ownersAdjustedEps"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>BPS</span><span class="pull-right stock text" id="sbrf_ownersAdjustedBps"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>섹터</span><span class="pull-right stock" id="sbrf_wicsSectorName"></span></div>
    </div>
    <div class="col-3 col-6-medium">
      <div><span>배당(원)</span><span class="pull-right stock text" id="sbrf_commonAdjustedDps"></span></div>
    </div>

  </div>
  <!-- Stock Bar of 52 Weeks -->
  <div calss="row">
    <div id="percent-box" class="box" style="padding: 0.8em;">
      <span>52주 최저</span>
      <span class="pull-right">52주 최고</span>
      <div class="bar container">
        <div id="sbrf_percent" class="bar percent"></div>
      </div>
      <span id="sbrf_high52wPrice" class="pull-right"></span>
      <span id="sbrf_low52wPrice"></span>
    </div>
  </div>
  <!-- <div id="chart-candle" style="width: 100%; height: 500px;"></div> -->
  <div>
    <h4>Investor Trands</h4>
    <div class="btn-group">
      <button type="button" class="button bottom small gray button-investor" value="investor3">3M</button>
      <button type="button" class="button bottom small button-investor" value="investor6">6M</button>
      <button type="button" class="button bottom small button-investor" value="investor12">1Y</button>
      <button type="button" class="button bottom small button-investor" value="investor24">2Y</button>
      <button type="button" class="button bottom small button-investor" value="investor36">3Y</button>
    </div>
    <div class="row">
      <div id="chart-investor" style="width: 99%; height: 350px;"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-4 col-12-medium">
      <h4 id="investors-trading"><span class="fa fa-caret-right"></span> Investors Trading</h4>
      <table id="investors-trading-table" style="display: none;">
        <thead>
          <tr><th>Date</th><th class="align-center" colspan="2">Foreign</th><th>Institute</th><th>Person</th><tr>
        </thead>
        <tbody id="tbody-invtbl">
        </tbody>
      </table>
    </div>
    <div class="col-8 col-12-medium">
      <h4 id="daily-price"><span class="fa fa-caret-right"></span> Daily Price</h4>
      <div id="daily-price-table" style="display: none;">
        <table>
          <thead>
            <tr><th>Date</th><th>End</th><th>Rate</th><th>Start</th><th>High</th><th>Low</th><th>Volume</th><tr>
          </thead>
          <tbody id="tbody-daily">
          </tbody>
        </table>  
      </div>
    </div>
  </div>

  <div>
    <div>
      <h3>Data</h3>
      <ul class="row actions">
        <li><a href="#" class="button small" id="download-csv">CSV</a></li>
      </ul>    
    </div>
    <div>
      <h3>Simulation</h3>
      <ul class="row actions" style="margin-bottom: 0.3em;">
        <!-- algo index -->
        <li><a href="#" class="simulation control bottom button small" id="draw-index-previous">&lt;</a></li>
        <li><input type="text" class="simulation control small" id="simulation-index" style="width: 5.5em;" placeholder="Index"/></li>
        <li><a href="#" class="simulation control bottom button small" id="draw-index-next">&gt;</a></li>
        <!-- return rate -->
        <li><a href="#" class="simulation control bottom button small" id="draw-rrate-down">&lt;</a></li>
        <li><input type="text" class="simulation control small" id="simulation-rrate" style="width: 4em;" value="7.0" placeholder="Return Rate"/></li>
        <li><a href="#" class="simulation control bottom button small" id="draw-rrate-up">&gt;</a></li>
        <!-- months -->
        <li><input type="text" class="simulation control small" id="simulation-months" style="width: 5.5em;" placeholder="months"/></li>
        <li><a href="#" class="simulation control bottom button small" id="draw-simulation-chart">Chart</a></li>
        <li><a href="#" class="simulation control bottom button small" id="download-simulation-csv">CSV</a></li>
        <li><a href="#" class="simulation control bottom button small" id="download-simulation-mark">MARK</a></li>
      </ul>
      <span class="etc small">MARK - Click & Click to SET, Double-Click & Click to RESET</span>
      <ul class="row actions">
        <li><a href="#" class="simulation control button small gray button-simulation" value="6">6M</a></li>
        <li><a href="#" class="simulation control button small button-simulation" value="12">1Y</a></li>
        <li><a href="#" class="simulation control button small button-simulation" value="24">2Y</a></li>
        <li><a href="#" class="simulation control button small button-simulation" value="0">MAX</a></li>
      </ul>
    </div>
    <div class="simulation area" style="display: none;">
      <div class="row">
        <div id="simulation-chart" style="width: 99%; height: 350px;"></div>
        <div style="width: 100%;">
          <ul class="row actions etc small" style="margin-bottom: 0.3em;">
            <li style="width: 6em;"><b>Date</b></li>
            <li id="simulation-chart-date"></li>
          </ul>          
          <ul class="row actions etc small" style="margin-bottom: 0.3em;">
            <li style="width: 6em;" id="simulation-chart-bpoint"><b>Buying</b></li>
            <li><span>Average:</span> <span id="simulation-chart-bavg" style="color: black;"></span></li>
            <li><span>Count:</span> <span id="simulation-chart-bvolume"></span></li>
            <li><span>Reason:</span> <span id="simulation-chart-breason"></span></li>
          </ul>
          <ul class="row actions etc small" style="margin-bottom: 0.3em;">
            <li style="width: 6em;" id="simulation-chart-spoint"><b>Sell</b></li>
            <li><span>Profit:</span> <span id="simulation-chart-sprofit" style="color: black;"></span></li>
            <li><span>Reason:</span> <span id="simulation-chart-sreason"></span></li>
          </ul>
          <ul class="row actions etc small" style="margin-bottom: 0.3em;">
            <li style="width: 6em;"><b>Comment</b></li>
            <li><span>B0#:</span> <span>Buy-1st Low Point</span></li>
            <li><span>B1#:</span> <span>Buy-2nd Low Point with UP</span></li>
            <li><span>BD#:</span> <span>Buy-High Dropping</span></li>
            <li><span>Av#:</span> <span>Buy-Lower Average</span></li>
          </ul>
          <ul class="row actions etc small" style="margin-bottom: 0.3em;">
            <li style="width: 6em;"></li>
            <li><span>TH#:</span> <span>Too High</span></li>
            <li><span>TL#:</span> <span>Too Low</span></li>
            <li><span>TS#:</span> <span>Threshold of HHUPUP</span></li>
          </ul>
          <ul class="row actions etc small" style="margin-bottom: 0.3em;">
            <li style="width: 6em;"></li>
            <li><span>SN#:</span> <span>Sell Normal</span></li>
            <li><span>SD#:</span> <span>Sell for High Dropping</span></li>
          </ul>
        </div>
      </div>
      <div style="display: none;">
        <ul class="row actions pull-right">
          <li><a href="#" class="simulation control button small shift" value="-6">&gt;</a></li>
        </ul>
        <ul class="row actions">
          <li><a href="#" class="simulation control button small shift" value="6">&lt;</a></li>
        </ul>
      </div>
      <div id="simulation-config"></div>
    </div>

{% if extra_info.algo %}
    <h3>Algo Brief</h3>
    <div id="algo-brief-load">
      <ul class="row actions">
        <li><a href="#" class="button small yellow" id="button-algo-brief-load">Load</a></li>
      </ul>    
    </div>
    <div id="algo-brief-area" style="display: none;">
      <div>
        <!-- <ul class="row actions" style="margin-bottom: 0.3em;">
          <li style="width: 7.5em;"><b class="etc small">Sell Mode</b></li>
          <li>
            <select class="etc bottom small" name="algo-brief-sell" id="algo-brief-sell">
              <option value="0">All</option>
              <option value="3">SM3</option>
              <option value="4">SM4</option>
            </select>
          </li>
        </ul> -->
        <ul class="row actions" style="margin-bottom: 0.3em;">
          <li style="width: 7.5em;"><b class="etc small">Drop Rate</b></li>
          <li>
            <select class="etc bottom small" name="algo-brief-droprate" id="algo-brief-droprate">
              <option value="0">All</option>
              <option value="7">7</option>
              <option value="3">3</option>
            </select>
          </li>
        </ul>
        <ul class="row actions" style="margin-bottom: 0.3em;">
          <li style="width: 7.5em;"><b class="etc small">Return Rate</b></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-return-begin" placeholder="Begin" style="width: 7.5em;" /></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-return-end" placeholder="End | None" style="width: 7.5em;" /></li>
        </ul>
        <ul class="row actions" style="margin-bottom: 0.3em;">
          <li style="width: 7.5em;"><b class="etc small">Investment Days</b></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-idays-begin" placeholder="Begin" style="width: 7.5em;" /></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-idays-end" placeholder="End | None" style="width: 7.5em;" /></li>
        </ul>  
        <ul class="row actions" style="margin-bottom: 0.3em;">
          <li style="width: 7.5em;"><b class="etc small">Earn. count</b></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-ecount-begin" placeholder="Begin" style="width: 7.5em;" /></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-ecount-end" placeholder="End | None" style="width: 7.5em;" /></li>
        </ul>    
        <ul class="row actions" style="margin-bottom: 0.3em;">
          <li style="width: 7.5em;"><b class="etc small">Last E. count</b></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-lecount-begin" placeholder="Begin" style="width: 7.5em;" /></li>
          <li><input type="text" class="etc bottom small" id="algo-brief-lecount-end" placeholder="End | None" style="width: 7.5em;" /></li>
        </ul>    
        <ul class="row actions" style="margin-bottom: 0.3em;">
          <li style="width: 7.5em;"></li>
          <li><a href="#" class="algo brief table bottom button small disabled gray" id="algo-brief-table-filter-out">APPLY</a></li>
        </ul>    
      </div>
      <div class="row">
        <div class="col-12 col-12-medium">
          <div class="row" style="margin-bottom: 0.3em;">
            <div class="col-3 col-6-medium etc small"><B>Build Date</B></div>
            <div class="col-3 col-6-medium etc small"><div id="algo-brief-build-date"></div></div>
            <div class="col-3 col-6-medium etc small"><B>MD5SUM</B></div>
            <div class="col-3 col-6-medium etc small"><div id="algo-brief-md5sum"></div></div>
            <div class="col-3 col-6-medium etc small"><B>Earnings Count</B></div>
            <div class="col-3 col-6-medium etc small"><div id="algo-brief-max-ecount"></div></div>
            <div class="col-3 col-6-medium etc small"><B>Last Earnings Count</B></div>
            <div class="col-3 col-6-medium etc small"><div id="algo-brief-max-lecount"></div></div>
          </div>
          
          <ul class="row actions" style="margin-bottom: 0.3em;">
            <li><a href="#" class="algo brief table bottom button small disabled" id="algo-brief-table-previous">&lt;</a></li>
            <li><input type="text" class="algo brief table small" id="algo-brief-table-index" value="0" style="width: 5em;" disabled/></li>
            <li>/ <span id="algo-brief-table-max-index"></span></li>
            <li><a href="#" class="algo brief table bottom button small disabled" id="algo-brief-table-next">&gt;</a></li>
          </ul>
          
          <table class="etc small">
          <thead>
              <tr><th>Index</th><th>Sum</th><th>MinMax</th><th>DRate</th><th>HhUpUp</th><th>Sell</th><th>IAmount</th><th>Return</th><th>IDays</th><th>ECount</th><th>LECount</th><tr>
            </thead>
            <tbody id="algo-brief-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <p/>
{% endif %} 
  </div>

  {% if current_user.is_authorized('ADMIN') %}
  <p/>
  <div class="row">
    <div class="col-12 col-12-medium col-12-small">
      <h3 id="adjust-split-stock"><span class="fa fa-caret-right"> Adjust Split Stock</span></h3>
      <div id="adjust-split-stock-table" style="display: none;">
        <table>
          <thead></thead>
          <tbody>
            <tr><th>Ratio</th><td><input type="text" id="ass-ratio" value="" placeholder="Ratio" /></td><tr>
            <tr><th>From Date</th><td><input type="text" id="ass-from-date" value="" placeholder="YYYY-MM-DD" /></td><tr>
            <tr><th>To Date</th><td><input type="text" id="ass-to-date" value="" placeholder="None | YYYY-MM-DD" /></td><tr>
            <tr><td colspan="2">
              <div class="pull-right"><button id="button-ass-apply" class="button small gray">Apply</button></div>
              <div id="ass-msg"></div>
            </td><tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</section>
{% endblock %}

{% block bodyscript %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  $(function(){
    _code = "{{ extra_info.code }}";
    _data = {
      investor: 'investor3',
      chart: {
        simulation: {
          index: null,
          key: 6,
          data: null,
          months: null,
          rrate: null,
          today_brief: false
        }
      },
      algo: {
        have: {{ extra_info.algo|tojson }},
        mark: {{ extra_info.algo_index|tojson }},
        fields: null,
        filtered: null,
        index: null,
      }
    };
    _chartWidth = null;
    // // check mobild
    // if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    //   $("#algo-brief").hide();
    // } else {
    //   $("#algo-brief").show();
    // }

    // Chart
    google.charts.load('current', {'packages':['corechart']});
    // google.charts.setOnLoadCallback(drawChartCandle);
    google.charts.setOnLoadCallback(drawChartInvestorTrand);
    //create trigger to resizeEnd event
    $(window).resize(function() {
        if(this.resizeTO) clearTimeout(this.resizeTO);
        this.resizeTO = setTimeout(function() {
            $(this).trigger('resizeEnd');
        }, 250);
    });
    //redraw graph when window resize is completed
    $(window).on('resizeEnd', function() {
        // drawChartCandle();
        _chartWidth = null
        drawChartInvestorTrand();
    });

    // Initialize
    stock.kakao_brief_stock(_code, render_kakao_brief_stock);
    stock.kakao_brief_company(_code, render_kakao_brief_company);
    stock.query_investors_table(_code, 1, render_investors_table);
    stock.query_daily_table(_code, 1, render_daily_table);
    initButtonInvestor();
    init_extra_buttons();
    init_ass_button();
    init_algo_brief_load();

    util.gui.show.area("#investors-trading", "#investors-trading span", "#investors-trading-table");
    util.gui.show.area("#daily-price", "#daily-price span", "#daily-price-table");
    util.gui.show.area("#adjust-split-stock", "#adjust-split-stock span", "#adjust-split-stock-table")
  });

  function init_extra_buttons() {
    let sim_ctl_selector = $('.simulation.control');
    let sim_area_selector = $('.simulation.area');
    let index_selector = $("#simulation-index");
    let rrate_selector = $("#simulation-rrate");
    let months_selector = $("#simulation-months");
    let mark_selector = $("#download-simulation-mark");
    let get_index = function(){
      let index = parseInt(index_selector.val());
      return (isNaN(index)) ? 0 : index;
    };
    let get_rrate = function(){
      let rrate = parseFloat(rrate_selector.val());
      return (isNaN(rrate)) ? 7.0 : rrate;
    }
    mark_selector.on('click', function(e){
      e.preventDefault();
      if ($(this).hasClass('blue')) {
        $(this).removeClass('blue').removeClass('red').text('MARK');
        stock.query_algo_index_mark(_code, index_selector.val(), function(resp){});
      } else if($(this).hasClass('red')){
        $(this).removeClass('blue').removeClass('red').text('MARK');
        stock.query_algo_index_mark(_code, null, function(resp){});
      } else {
        $(this).addClass('blue').text('SET');
      }
    }).on('dblclick', function(e){
      e.preventDefault();
      $(this).removeClass('blue').addClass('red').text('CLEAR');
    });
    $(".button-simulation").each(function(idx){
      $(this).on("click", function(e){
        e.preventDefault();
        mark_selector.removeClass('blue').removeClass('red').text('MARK');
        // inactived button, set the default
        $(".button-simulation").each(function(idx){
          $(this).removeClass("gray")
        });
        // activating the selected button
        $(this).addClass("gray");
        let key = parseInt($(this).attr('value'));
        if (_data.chart.simulation.key == key) {
          return;
        }
        _data.chart.simulation.key = key;
        draw_chart(get_index());
      });
    });
    $(".simulation.control.shift").each(function(idx){
      // TODO: Shift Graphic as a direction button.
    });
    $("#download-csv").on('click', function(e){
      let selector = $("#download-csv");
      let to_csv = function(data){
        let title = $("header h2 a").text();
        // let date = new Date().toISOString();
        util.file.query_to_csv(title+'-daily.csv', title, data);
        selector.removeClass('disabled');
      };
      e.preventDefault();
      selector.addClass('disabled');
      stock.query_table(_code, 60, to_csv);
    });
    $("#download-simulation-csv").on('click', function(e){
      let to_csv = function(data){
        let title = $("header h2 a").text();
        // let date = new Date().toISOString();
        index_selector.val(data.cfg.algo.index);
        util.file.sim_data_to_csv(title+'-simulation.csv', title, data);
        sim_ctl_selector.each(function(idx){$(this).removeClass('disabled');});
      };
      e.preventDefault();
      sim_ctl_selector.each(function(idx){$(this).addClass('disabled');});
      let rrate = rrate_selector.val();
      rrate = (rrate.length > 0) ? parseFloat(rrate) : 7.0;
      let months = (months_selector.val().length > 0)?Math.max(parseInt(months_selector.val()),72):null;
      let options = {return_rate: rrate};
      if (months) options.months = months;
      stock.query_simulation(_code, get_index(), options, to_csv);
    });
    let dump_brief = function(cfg, report) {
      let brief= [
      '<table class="etc small">',
      '  <thead>',
      '    <tr><th>Index</th><th>Sum</th><th>MinMax</th><th>DRate</th><th>HhUpUp</th><th>Sell</th><th>IAmount</th><th>Return</th><th>IDays</th><th>ECount</th><th>LECount</th><tr>',
      '  </thead>',
      '  <tbody>',
      '    <tr>',
      '      <td>'+cfg.algo.index+'</td>',
      '      <td>'+cfg.sum.accums.join(' ')+'</td>',
      '      <td>'+cfg.minmax.accums.join(' ')+'</td>',
      '      <td>'+cfg.buy.dropping_rate+'</td>',
      '      <td>'+cfg.buy.after.hhupup.begin+' '+cfg.buy.after.hhupup.append+' '+cfg.buy.after.hhupup.hhup_lwhh.begin+' '+cfg.buy.after.hhupup.hhup_lwhh.append+' '+cfg.buy.after.hhupup.thresholds+'</td>',
      '      <td>'+cfg.sell.method+'</td>',
      '      <td>'+report.investment_amount+'</td>',
      '      <td>'+report.return_rate+'</td>',
      '      <td>'+report.investment_days+'</td>',
      '      <td>'+report.earnings_count+'</td>',
      '      <td>'+report.last_earnings_count+'</td>',
      '    </tr>',
      '  </tbody>',
      '</table>'
      ];
      return brief.join(' ');
    };
    let draw_chart = function(index) {
      let sim_data_selector = $("#simulation-config");
      let chart_today_brief = function(data){
        // console.log(data);
        if (_data.chart.simulation.today_brief) {
          _data.chart.simulation.today_brief = false;
          if (data.chart.today.spoint) $('#simulation-chart-spoint').append('&nbsp;&nbsp;<span class="fa fa-star pull-right" style="color: white;"></span>').addClass('etc round bg-red');
          if (data.chart.today.bpoint) $('#simulation-chart-bpoint').append('&nbsp;&nbsp;<span class="fa fa-star pull-right" style="color: white;"></span>').addClass('etc round bg-gray');

          $('#simulation-chart-date').html('&nbsp;<span>'+data.chart.today.date+'</span>');
          $('#simulation-chart-bavg').text(util.formatNumber(data.chart.today.bavg));
          $('#simulation-chart-bvolume').text(util.formatNumber(data.chart.today.bvolume));
          $('#simulation-chart-breason').text(data.chart.today.breason);
          $('#simulation-chart-sreason').text(data.chart.today.rseason);
          let profit = data.chart.today.sprofit;
          $('#simulation-chart-sprofit').text(profit?profit+'%':'None');
        }
      };
      let do_draw = function(data){
        setTimeout(function(){
          sim_area_selector.each(function(i){$(this).show()});
          // let info = '<b>CFG</b><br/>'+JSON.stringify(data.cfg)+'<br/><b>REPORT</b><br/>'+JSON.stringify(data.report);
          index_selector.val(data.cfg.algo.index);
          sim_data_selector.html(dump_brief(data.cfg, data.report));
          drawSimulationChart(data);
          _data.chart.simulation.index = data.cfg.algo.index;
          _data.chart.simulation.data = data;
          sim_ctl_selector.each(function(i){$(this).removeClass('disabled');});
          chart_today_brief(data);
        }, 100);
      }
      let rrate = parseFloat(rrate_selector.val());
      let months = (months_selector.val().length > 0)?Math.max(parseInt(months_selector.val()),72):null;
      if (_data.chart.simulation.index != index || _data.chart.simulation.months != months || _data.chart.simulation.rrate != rrate) {
        let options = (months) ? {months: months} : {};
        options.return_rate = rrate;
        _data.chart.simulation.rrate = rrate;
        _data.chart.simulation.months = months;
        _data.chart.simulation.today_brief = true;
        sim_data_selector.html('');
        sim_ctl_selector.each(function(i){$(this).addClass('disabled');});
        stock.query_simulation_chart(_code, index, options, do_draw);
      } else {
        do_draw(_data.chart.simulation.data);
      }
    };
    $("#draw-simulation-chart").on('click', function(e){
      e.preventDefault();
      draw_chart(get_index());
    });
    $("#draw-index-previous").on('click', function(e){
      e.preventDefault();
      draw_chart(Math.max(get_index()-1, 0));
    });
    $("#draw-index-next").on('click', function(e){
      e.preventDefault();
      draw_chart(get_index()+1);
    });
    $("#draw-rrate-down").on('click', function(e){
      e.preventDefault();
      let rrate = get_rrate() - 0.1;
      rrate_selector.val(rrate.toFixed(1));
      draw_chart(get_index());
    });
    $("#draw-rrate-up").on('click', function(e){
      e.preventDefault();
      let rrate = get_rrate() + 0.1;
      rrate_selector.val(rrate.toFixed(1));
      draw_chart(get_index());
    });
    if (_data.algo.mark) {
      setTimeout(function(){
        $('#simulation-index').val(parseInt(_data.algo.mark));
        document.getElementById('draw-simulation-chart').click();
      }, 100);
    }
  }

  function initButtonInvestor() {
    var months = [3, 6, 12, 24, 36];
    for (var i in months) {
        stock.query_investors_graph(_code, months[i], collectInvestorTrand);
    }
    $(".button-investor").each(function(idx){
      $(this).on("click", function(){
        // inactived button, set the default
        $(".button-investor").each(function(idx){
          $(this).removeClass("gray")
        });
        // activating the selected button
        $(this).addClass("gray");
        var key = $(this).val()
        // console.log(key);
        _data.investor = key;
        drawChartInvestorTrand();
      });
    });
    $(".button-candle").each(function(idx){
      $(this).on("click", function() {
        $(".button-candle").each(function(idx){
          $("#"+$(this).val()).hide();
          $(this).removeClass('gray');
        });
        $("#"+$(this).val()).show();
        $(this).addClass('gray');
      })
    });
  }

  function init_ass_button() {
    $("#button-ass-apply").on('click', function(){
      let code = _code;
      let ratio = $("#ass-ratio").val();
      let from_date = $("#ass-from-date").val();
      let to_date = $("#ass-to-date").val();
      let period = 1.5;
      let params = {};

      do
      {
        if (isNaN(parseFloat(ratio))) {
          util.gui.spot_flash('#ass-msg', 'Invalid a Ratio', 'red', period);
          break;
        }
        if ( ! util.isValidDate(from_date)) {
          util.gui.spot_flash('#ass-msg', 'Invalid a From Date', 'red', period);
          break;
        }
        if (to_date) {
          if ( ! util.isValidDate(to_date)) {
            util.gui.spot_flash('#ass-msg', 'Invalid a To Date', 'red', period);
            break;
          } else {
            params.edate = to_date;
          }
        }
        code = util.paddingNumber(code, 6);
        params.ratio = ratio;
        params.sdate = from_date;
        util.gui.spot_flash('#ass-msg', 'Processing ...', 'orange', 0);
        stock.adjust_stock_split(code, params, function(resp){
          $("#ass-ratio").val('');
          $("#ass-from-date").val('');
          $("#ass-to-date").val('');
          util.gui.spot_flash('#ass-msg', 'Done to adjust.', 'green', 0);
        });
      }while(false);
    });
  }

  function init_algo_brief_load() {
    $("#button-algo-brief-load").on('click', function(e){
      e.preventDefault();
      $("#algo-brief-load").hide();
      $("#algo-brief-area").show();
      init_algo_brief();
    });
  }

  function init_algo_brief(){
    let tbody_selector = $("#algo-brief-tbody");
    let algo_brief_nav_selector = $('.algo.brief.table');
    let algo_brief_nav_previous = $('#algo-brief-table-previous');
    let algo_brief_nav_index = $("#algo-brief-table-index");
    let algo_brief_table_max_index = $('#algo-brief-table-max-index');
    let algo_brief_nav_next = $('#algo-brief-table-next');
    let algo_brief_table_filter_out = $('#algo-brief-table-filter-out');
    let algo_brief = {};
    algo_brief.table_nav_enable = function(enable){
      algo_brief_nav_selector.each(function(idx){
        if (enable) {
          if ($(this).get(0).tagName == 'A')
            $(this).removeClass('disabled');
          else
            $(this).removeAttr('disabled');
        } else {
          if ($(this).get(0).tagName == 'A')
            $(this).addClass('disabled');
          else
            $(this).attr('disabled','disabled');
        }
      });      
    };
    algo_brief.table_nav_next = function(e){
      let index = parseInt(algo_brief_nav_index.val());
      if (isNaN(index)) index = 0;
      if ((index+1) < _data.algo.max_index) {
        algo_brief_nav_index.val(index+1);
      }
      algo_brief.render_tbody();
    };
    algo_brief.table_nav_previous = function(e){
      let index = parseInt(algo_brief_nav_index.val());
      if (isNaN(index)) index = 0;
      if ((index-1) >= 0) {
        algo_brief_nav_index.val(index-1);
      }
      algo_brief.render_tbody();
    };
    algo_brief._filter_sell = function(data){
      // Removed Sell 3 Mode, It have not items.
      return data;
      // let filtered = [];
      // let selector = 'algo-brief-sell';
      // let foSell = $('#'+selector).val();
      // let isell = _data.algo.colnames.indexOf(selector.split('-').pop());
      // if (foSell == 0)
      //   return data;
      // for (field of data) {
      //   if (field[isell] == foSell)
      //     filtered.push(field);
      // }
      // return filtered;
    };
    algo_brief._filter_dropping_rate = function(data){
      let filtered = [];
      let selector = 'algo-brief-droprate';
      let idroprate = _data.algo.colnames.indexOf(selector.split('-').pop());
      let drate = $('#'+selector).val();
      if (drate == 0)
        return data;
      for (field of data) {
        if (field[idroprate] == drate)
          filtered.push(field)
      }
      return filtered;
    };
    algo_brief._filter_range = function(selector, data) {
      let foBegin = $('#'+selector+'-begin').val();
      let foEnd = $('#'+selector+'-end').val();
      let tag = selector.split('-').pop();
      let itag = _data.algo.colnames.indexOf(tag);
      if (foBegin.length == 0 && foEnd.length == 0)
        return data;
      let filtered = [];
      if (foBegin.length > 0 && foEnd.length > 0) {
        let begin = parseFloat(foBegin);
        let end = parseFloat(foEnd);
        for (field of data) {
          let item = field[itag];
          if (begin <= item && item <= end) filtered.push(field);
        }
      } else if (foBegin.length > 0) {
        let begin = parseFloat(foBegin);
        for (field of data) {
          let item = field[itag];
          if (begin <= item) filtered.push(field);
        }
      } else if (foEnd.length > 0){
        let end = parseFloat(foEnd);
        for (field of data) {
          let item = field[itag];
          if (item <= end) filtered.push(field);
        }
      } else {
        return data;
      }
      return filtered;
    };
    algo_brief.filter_out = function(){
      let filtered = [];
      // console.log(_data.algo.colnames);
      filtered = algo_brief._filter_sell(_data.algo.fields);
      filtered = algo_brief._filter_dropping_rate(filtered);
      for (tag of ['return', 'idays', 'ecount', 'lecount']) {
        filtered = algo_brief._filter_range('algo-brief-'+tag, filtered);
      }
      _data.algo.filtered = filtered;
      let lastIAlign = (_data.algo.filtered.length%100) == 0 ? 0 : 1;
      _data.algo.index = -1;
      _data.algo.max_index = parseInt(_data.algo.filtered.length/100 + lastIAlign);
      algo_brief_table_max_index.text(_data.algo.max_index-1);
    };
    algo_brief.render_tbody_field = function(items){
      let html = '<tr>';
      html += '<td><a href="#" class="algo brief index">'+items[0]+'</a></td>'
      for (it of items.slice(1)){ 
        html += '<td>'+it+'</td>'; 
      }
      return html+'</tr>';
    };
    algo_brief.render_tbody = function(){
      let tbody = '';
      let index = parseInt(algo_brief_nav_index.val());
      let min = index * 100;
      let max = (index+1) * 100;
      if (index != _data.algo.index) {
        for (let iindex=min; iindex<max; iindex++){
          let field = _data.algo.filtered[iindex];
          if (field) tbody += algo_brief.render_tbody_field(field);
        }
        tbody_selector.html(tbody);
        _data.algo.index = index;
        $('.algo.brief.index').each(function(idx){
          $(this).on('click', function(e){
            e.preventDefault();
            let index = $(this).text();
            $('#simulation-index').val(index);
            document.getElementById('draw-simulation-chart').click();
            console.log('index', index);
          });
        });
      }
      algo_brief.table_nav_enable(true);
    };
    algo_brief.render = function(data){
      $('#algo-brief-build-date').text(data.build_date);
      $('#algo-brief-md5sum').text(data.md5sum);
      $('#algo-brief-max-ecount').text(data.max_ecount);
      $('#algo-brief-max-lecount').text(data.max_lecount);
      _data.algo.colnames = data.colnames;
      _data.algo.fields = data.fields;
      _data.algo.max_index = 0;
      algo_brief.filter_out();
      algo_brief.render_tbody();
    };
    algo_brief.clear = function(){
      $('#algo-brief-build-date').text('');
      $('#algo-brief-md5sum').text('');
      $('#algo-brief-max-ecount').text('');
      $('#algo-brief-max-lecount').text('');
      algo_brief.table_nav_enable(false);
      tbody_selector.html('');
    };
    let load_algo_brief = function(){
      stock.query_algo_brief(_code, {}, algo_brief.render);
    };
    algo_brief.clear();
    algo_brief_nav_next.on('click', function(e){
      algo_brief.table_nav_enable(false);
      e.preventDefault();
      algo_brief.table_nav_next(e);
    });
    algo_brief_nav_previous.on('click', function(e){
      algo_brief.table_nav_enable(false);
      e.preventDefault();
      algo_brief.table_nav_previous(e);
    });
    algo_brief_table_filter_out.on('click', function(e){
      algo_brief.table_nav_enable(false);
      e.preventDefault();
      algo_brief_nav_index.val(0);
      algo_brief.filter_out();
      algo_brief.render_tbody();
    });
    load_algo_brief();
  }

  function render_kakao_brief_stock(data){
    _data.code = data;
    console.log(data);
    $("#sbrf_tradePrice").text(util.formatNumber(data.tradePrice));
    $("#sbrf_changePrice").text(util.formatNumber(data.changePrice));
    $("#sbrf_changeRate").text((data.changePriceRate*100).toFixed(2)+' %');
    $("#sbrf_change").addClass(data.change=='RISE'?'color-up':data.change=='FALL'?'color-down':'');
    $("#sbrf_miniDayChartUrl").attr('src', data.dayChartUrl);

    var percent = (data.tradePrice-data.low52wPrice)/(data.high52wPrice-data.low52wPrice)*100;
    $("#sbrf_prevClosingPrice").text(util.formatNumber(data.prevClosingPrice));
    $("#sbrf_openingPrice").text(util.formatNumber(data.openingPrice)).addClass(stock.text_compare_color(data.prevClosingPrice, data.openingPrice));
    $("#sbrf_lowPrice").text(util.formatNumber(data.lowPrice)).addClass(stock.text_compare_color(data.prevClosingPrice, data.lowPrice));
    $("#sbrf_highPrice").text(util.formatNumber(data.highPrice)).addClass(stock.text_compare_color(data.prevClosingPrice, data.highPrice));
    $("#sbrf_accTradeVolume").text(util.formatNumber(data.accTradeVolume));
    $("#sbrf_globalAccTradePrice").text(util.formatNumber(Math.ceil(data.globalAccTradePrice/100000000)+' 억'));
    $("#sbrf_totalMarketValue").text(util.formatNumber(Math.ceil(data.totalMarketValue/100000000))+' 억');
    $("#sbrf_foreignRatio").text((parseFloat(data.foreignRatio)*100).toFixed(1)+' %');

    $("#sbrf_percent").css('width', ''+percent+'%');
    $("#sbrf_high52wPrice").text(util.formatNumber(data.high52wPrice));
    $("#sbrf_low52wPrice").text(util.formatNumber(data.low52wPrice));
  }
  function render_kakao_brief_company(data) {
      $("#sbrf_ownersAdjustedEps").text(util.formatNumber(parseInt(data.ownersAdjustedEps)));
      $("#sbrf_ownersAdjustedBps").text(util.formatNumber(parseInt(data.ownersAdjustedBps)));
      $("#sbrf_commonAdjustedDps").text(util.formatNumber(parseInt(data.commonAdjustedDps)));
      $("#sbrf_wicsSectorName").css('font-weight', '400').text(data.wicsSectorName);
  }
  function render_investors_table(data) {
    var td_number = function(num) {
      return '<td class="'+stock.text_color_ralign(num, true)+'">'+util.formatNumber(parseInt(num/1000))+'</td>';
    }
    var td_foreigner = function(num, percent) {
      return td_number(num)+'<td>'+parseFloat(percent).toFixed(1)+'%</td>';
    };
    data.fields.reverse();
    // console.log(data);
    var str = '';
    for (var i in data.fields) {
      if (i >= (data.fields.length-1))
        continue;
      var field = data.fields[i];
      var dates = field[0].split('-');
      if (field[2] == null)
          continue;
      str += '<tr>';
      str += '<td class="align-right">'+parseInt(dates[1])+'.'+parseInt(dates[2])+'</td>';
      str += td_foreigner(field[1], field[2]);
      str += td_number(field[3]);
      str += td_number(field[4]);
      str += '</tr>';
    }
    $("#tbody-invtbl").append(str);
  }
  function render_daily_table(data) {
    data.fields.reverse();
    console.log(data);
    var str = '';
    for (var i in data.fields) {
      if (i >= (data.fields.length-1))
        continue;
      i = parseInt(i);
      var field = data.fields[i];
      var pfield = data.fields[(i+1)];
      var dates = field[0].split('-');
      var numrate = field[4] - pfield[4];
      str += '<tr>';
      str += '<td class="align-right">'+parseInt(dates[1])+'.'+parseInt(dates[2])+'</td>';
      str += '<td class="align-right">'+util.formatNumber(field[4])+'</td>';
      str += '<td class="'+stock.text_color_ralign(numrate, true)+'">'+util.formatNumber(numrate)+'</td>';
      str += '<td class="align-right">'+util.formatNumber(field[1])+'</td>';
      str += '<td class="align-right">'+util.formatNumber(field[2])+'</td>';
      str += '<td class="align-right">'+util.formatNumber(field[3])+'</td>';
      str += '<td class="align-right">'+util.formatNumber(field[5])+'</td>';
      str += '</tr>';
    }
    $("#tbody-daily").append(str);
  }
  function collectInvestorTrand(resp) {
    // console.log(resp);
    var paths = resp.request.path.split("/");
    var invkey = 'investor'+paths[paths.length-1];
    var rawinvkey = 'raw-investor'+paths[paths.length-1];
    var data = {};
    var endIdx = resp.colnames.indexOf('end');
    var endmin=99999999, endmax=0;
    data.fields = [];
    data.colnames = resp.colnames;
    for (var row of resp.fields) {
      endmin = Math.min(endmin, row[endIdx]);
      endmax = Math.max(endmax, row[endIdx]);
      var date = row.shift();
      data.fields.push([new Date(date.split('-'))].concat(row));
      row.unshift(date);
    }
    data.endmin = parseInt(endmin * 0.95);
    data.endmax = parseInt(endmax * 1.05);
    _data[invkey] = data;
    _data[rawinvkey] = resp;
    // console.log(endmin, endmax);
  }
  function drawChartInvestorTrand() {
    var _draw = function() {
      var data = new google.visualization.DataTable();
      for (var i in invdata.colnames) {
        // console.log(invdata.colnames[i]);
        if (i == 0) {
          data.addColumn('date', 'X');
          continue
        }
        data.addColumn('number', invdata.colnames[i]);
      }
      data.addRows(invdata.fields);

      // console.log(invdata);
      if (_chartWidth == null) {
        _chartWidth = document.getElementById('chart-investor').offsetWidth;
      }
      // console.log('### '+document.getElementById('percent-box').offsetWidth);
      var options = {
        legend: { position: 'top' },
        width: _chartWidth,
        chartArea: {width: '92%', height: '75%', left: 0},
        // hAxis: {format: 'yy.M'},
        hAxis: {format: 'yy.M.d'},
        // vAxis: {textPosition: 'none'},
        vAxis: { 0: {gridlines: {color: 'transparent'}}, 
                 1: {maxValue: invdata.endmax, minValue: invdata.endmin} },
        vAxes: { 0: {ticks: [], textStyle: {fontSize: 0}},
                 1: {gridlines: { count:0}} },
        colors: ['#F5B041', '#A569BD', '#5DADE2', '#34495E', '#D5DBDB'],
        series: {
          4: {type: "area", targetAxisIndex: 1, areaOpacity: 0.25}
        }
      };
      var chart = new google.visualization.LineChart(document.getElementById('chart-investor'));
      chart.draw(data, options);
    };
    var invdata = _data[_data.investor];
    if (invdata) {
      _draw();
    } else {
      console.log('Retry to draw chart.')
      setTimeout(drawChartInvestorTrand, 250);
    }
  }

  function drawSimulationChart(sdata) {
    let data = new google.visualization.DataTable();
    let colnames = {};
    colnames.end = 'End';
    colnames.afhuu = "HUU";
    colnames.buycnt = "BPoint";
    colnames.sellcnt = "SPoint";
    for (var i in sdata.colnames) {
      if (i==0) {
        data.addColumn('date', 'X');
        continue;
      }
      data.addColumn('number', colnames[sdata.colnames[i]]);
    }
    if (sdata.cdata) {

    } else {
      let cdata = [];
      for (var row of sdata.fields) {
        let date = row.shift();
        cdata.push([new Date(date.split('-'))].concat(row));
      }
      sdata.cdata = cdata;
    }
    let sidx = _data.chart.simulation.key;
    sidx = (sidx == 0) ? 0 : (sdata.cdata.length - 23*sidx);
    sidx = Math.max(sidx, 0);
    data.addRows(sdata.cdata.slice(sidx));

    // console.log(invdata);
    if (_chartWidth == null) {
      _chartWidth = document.getElementById('chart-investor').offsetWidth;
    }
    // console.log('### '+document.getElementById('percent-box').offsetWidth);

    let options = {
      legend: { position: 'top' },
      width: _chartWidth,
      chartArea: {width: '92%', height: '75%', right: 0},
      // // hAxis: {format: 'yy.M'},
      hAxis: {format: 'yy.M.d'},
      // // vAxis: {textPosition: 'none'},
      // vAxis: { 0: {gridlines: {color: 'transparent'}}}, 
      //          1: {maxValue: invdata.endmax, minValue: invdata.endmin} },
      vAxes: { 1: {gridlines: { count:0}} },
      colors: ['blue', 'orange', 'gray', 'red'],
      series: {
        1: {targetAxisIndex: 1},
        2: {targetAxisIndex: 1},
        3: {targetAxisIndex: 1},
      }
    };
    let chart = new google.visualization.LineChart(document.getElementById('simulation-chart'));
    chart.draw(data, options);
  }

  // function drawChartCandle() {
  //   var data = google.visualization.arrayToDataTable([
  //     //  low, start, high, end
  //     ['Mon', 20, 28, 38, 45],
  //     ['Tue', 31, 38, 55, 66],
  //     ['Wed', 50, 55, 77, 80],
  //     ['Thu', 77, 77, 66, 50],
  //     ['Fri', 68, 66, 22, 15]
  //     // Treat first row as data as well.
  //   ], true);

  //   var options = {
  //     legend:'none',
  //     width: document.getElementById('chart-candle').offsetWidth,
  //     chartArea: {width: '85%', height: '75%'},
  //     candlestick: {
  //       risingColor: {stroke: 'red', fill: 'red'},
  //       fallingColor: {stroke: 'blue', fill: 'blue'}
  //     },
  //   };

  //   var chart = new google.visualization.CandlestickChart(document.getElementById('chart-candle'));
  //   chart.draw(data, options);
  // }
</script>
{% endblock %}
